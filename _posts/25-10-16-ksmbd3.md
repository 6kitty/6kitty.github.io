---
layout: post
title: "linux kernel"
categories:
  - Pwnable
tags:
  - pwn
  - kernel
last_modified_at: 2025-10-15
---

# 들어가며 

kernel 환경 구축은 처음이라서 일단 드림핵으로 basics 강의를 수강하였다. 

```
[주버전][부버전][개정판 번호]
ex) 6.6.30 
```

커널 버전은 위와 같이 구분한다. 사실 이러한 구분보다는 LTS/Stable 구분이 더 중요하다. 

LTS는 장기간의 지원을 제공하는 커널 버전이다. 이보다는 더 빠르게 기능이 추가되는 커널이 Stable이다. 대신 지원 기간은 더 짧다. 

또한, 리눅스 커널은 시스템 아키텍처마다 동작 방식이 약간씩 다르다. 소스 안 arch 디렉토리를 들어가면 각 아키텍처의 코드가 포함되어 있다. x86부터 arm, MIPS 등 hexagon 같은 이외 아키텍처도 많다. 

# Background 

## Kernel Space & User Space 

리눅스에서 메모리는 위 두 가지 스페이스로 구분하여 관리한다. 시스템의 안전성과 보안을 위함이다. 각 영역은 접근 권한이 다르며 user가 kernel space에 있는 리소스를 사용하기 위해서는 kernel에 요청을 해야하는데, 이때 이 요청을 **system cal** 이라고 한다. 

x86 기준, syscall 어셈블리 명령어로 요청을 수행한다. 

1. 시스템 콜 호출 
2. CPU는 커널 모드로 전환 
3. 시스템 콜의 진입점, `entry_SYSCALL_64()` 함수 진입 
4. 시스템 콜 테이블인 `sys_call_table` 로부터 유저가 요청한 시스템 콜 호출 

## task 

리눅스의 응용 프로그램은 `fork()`를 호출해서 **프로세스**를 생성하고, `pthread_create()`를 호출해서 **스레드**를 생성한다. 

1. 프로세스는 독립된 메모리 영역(코드, 데이터, 힙, 스택)을 가짐 
2. 스레드는 스택 제외 메모리 영역 공유 

다만, 커널 입장에서는 이 프로세스, 스레드를 구분하지 않고 모두 태스크로 정의한다. 응용 프로그램에서는 fork, pthread_create로 구분되지만, 커널 단으로 들어오면 모두 `copy_process()` 함수를 호출한다. 

그리고 이 태스크가 생성되면 `task_struct` 구조체가 할당된다. 

```c
struct task_struct {
#ifdef CONFIG_THREAD_INFO_IN_TASK
        /*
         * For reasons of header soup (see current_thread_info()), this
         * must be the first element of task_struct.
         */
        struct thread_info              thread_info;
#endif
        unsigned int                    __state;
        /* saved state for "spinlock sleepers" */
        unsigned int                    saved_state;
        /*
         * This begins the randomizable portion of task_struct. Only
         * scheduling-critical items should be added above here.
         */
        randomized_struct_fields_start
        void                            *stack;
        refcount_t                      usage;
        /* Per task flags (PF_*), defined further below: */
        unsigned int                    flags;
        unsigned int                    ptrace;
#ifdef CONFIG_SMP
        int                             on_cpu;
        struct __call_single_node       wake_entry;
        unsigned int                    wakee_flips;
        unsigned long                   wakee_flip_decay_ts;
        struct task_struct              *last_wakee;
        ...
```

구조체 나열 

## Memory Architecture 

task_struct의 멤버 mm은 메모리 아키텍처의 주소들을 담고 있다. 

```c
struct mm_struct {
        struct {
                /*
                 * Fields which are often written to are placed in a separate
                 * cache line.
                 */
                ...
                unsigned long start_code, end_code, start_data, end_data;
                unsigned long start_brk, brk, start_stack;
                unsigned long arg_start, arg_end, env_start, env_end;
                ...
        } __randomize_layout;
        /*
         * The mm_cpumask needs to be at the end of mm_struct, because it
         * is dynamically sized based on nr_cpu_ids.
         */
        unsigned long cpu_bitmap[];
};
```


## Slab Allocator 