---
layout: post
title: "[2주차] 함수 호출 분석"
categories: [System Hacking]
tags: []
last_modified_at: 2024-03-25
---

실행 파일 처음 열었을 때이다.

상단바에 모듈을 확인하면 ntdll.dll이다. 메인 함수가 있는 (파일명).exe로 가야 한다.

![Image 1](https://blog.kakaocdn.net/dna/AgEKN/btsF1TfL8QR/AAAAAAAAAAAAAAAAAAAAABpbyqJNqW7iPOizIKAbgVVSbuci-iALUMCcdmwnzEHY/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=F%2FJk%2Fgj97tyPDc%2BKbGX7XdBm%2FzI%3D)

보통 디버거에서 자동으로 중단점 설정을 해주는데 이때 메인 코드가 있는 곳에 중단점이 설정되어 있을 확률이 높다.

stackframe_practice.exe인 중단점 아무거나 더블 클릭하면 모듈이 stackframe_practice.exe로 넘어간다.

![Image 2](https://blog.kakaocdn.net/dna/b4hu7j/btsF1R92GOk/AAAAAAAAAAAAAAAAAAAAAPJj9Z0w8rPcYLEKrZgZGnvi_ue9czELPb4i3cVFqXpP/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=O%2F%2FPG5YpfW3z6pv1sUwTtEUFX%2FA%3D)

스터디 시간에 배운 것처럼 

push ebp 

mov ebp, esp의 형태를 띄는 걸 알 수 있다.

![Image 3](https://blog.kakaocdn.net/dna/bPq5ij/btsF2N0fyhp/AAAAAAAAAAAAAAAAAAAAAPP9AaxksxVbnhl6-8OIPutFXHRf25dJWdkHMgFvqhrB/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=oqcBPn2SSy0Fvcqa9gfbN4BRrFc%3D)

무슨 함수 호출을 볼까 하다가 malloc 함수 call을 자세히 보기로 했다.

![Image 4](https://blog.kakaocdn.net/dna/y0767/btsF2PwZYgn/AAAAAAAAAAAAAAAAAAAAAMnBKO3GIY5QvFF1umsgUavglSzcNQU6Gqd_ACoERRfv/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=mPPyjNTI0kVcUDQr0MKPx31Jjx8%3D)

malloc으로 들어가기 전 레지스터 상태이다.

![Image 5](https://blog.kakaocdn.net/dna/ceaA8A/btsF14uzkD8/AAAAAAAAAAAAAAAAAAAAAGN2Ku1zVSOrftLauWS28uT4NN2B3z-PaCdEpPkgTWlm/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=U23hcfOXkc07R2nef1g1hfhE%2FII%3D)

f7을 눌러 malloc 안으로 들어가도록 했다. eip 옆 주석을 보면 msvcrt.malloc임을 알 수 있다. msvcrt는 일종의 라이브러리, malloc 함수가 위치한 모듈 정도로 이해했다.

![Image 6](https://blog.kakaocdn.net/dna/b56Q1N/btsF1Ra9L2P/AAAAAAAAAAAAAAAAAAAAAG-QTTf3Kj43EJiPh_u1TbMPh7rH7m9ra7ViEgAPn1JN/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=RuEbOnoiW7g0p1PaYVK6CYYNcXs%3D)

이 함수에 들어오면 역시나 

push ebp

mov ebp, esp

가 반긴다.

![Image 7](https://blog.kakaocdn.net/dna/beP4MY/btsF4Z6EBF0/AAAAAAAAAAAAAAAAAAAAAGfqMxZBJDCeipUj7DchnO4vUYl-4MrOWIWG5X3Nc_8O/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=NZBfdFn33uT7J5h64NTdFaZz5j8%3D)

push ebp를 실행하면 

![Image 8](https://blog.kakaocdn.net/dna/bFIqKn/btsF2G75xoq/AAAAAAAAAAAAAAAAAAAAADZ5aa4jefqix6v7WgdVQbEVkTmvAvSSPdr0vci9nkkB/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=cyyrb0c4wo%2Fb6RJKEtb69pB9oxY%3D)

ebp에 있던 값이 

![Image 9](https://blog.kakaocdn.net/dna/bzpKEi/btsF2OSmMIy/AAAAAAAAAAAAAAAAAAAAANQAToPFTIwcw3oOJBN49cirdJRiI1IqO_vdP4Jy21Gv/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=l77Kwm4n8b87aQJSoLkbfNc5i3E%3D)

스택 상단에 배치된 걸 확인할 수 있다. 현재 스택 프레임은 다음과 같다.

| 스택 주소 | 배치된 값 | 주석 |
|------------|------------|------|
| 0061FED8  | 0061FF68  |      |
| 0061FEDC  | 004012E7  | stackframe_practice로 가는 ret |

![Image 10](https://blog.kakaocdn.net/dna/cXngxi/btsF3lWEN4w/AAAAAAAAAAAAAAAAAAAAAO3WxqByWJVNm0OGODa-7rcuOvqvP2uTUEczSeMvyCRx/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=0onFM1NH45SwuCW8GUFtBbRi07o%3D)

esp는 ebp의 값을 넣어준 주소가 된다.

![Image 11](https://blog.kakaocdn.net/dna/NFetu/btsF4AslXhP/AAAAAAAAAAAAAAAAAAAAADhbvtCxFXA_ZtYXN8Rmv52Bp4Z64IsOkDS_PpLOVCOf/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=%2Bbh%2Be97c13LVXcxNCH9KYDxkJtA%3D)

다음 mov ebp, esp를 해주면 

![Image 12](https://blog.kakaocdn.net/dna/cqU0Gn/btsF3C41BSH/AAAAAAAAAAAAAAAAAAAAAEsXLxxkzt69LrQgf0hWSzp28CHFM794_JD6vFfyz4ga/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=btd5pQ8H%2F349uWocmaCJSVVbFHw%3D)

ebp가 esp가 있는 곳까지 올라오면서 동일해진다. 이제 malloc 함수의 데이터 범위가 지정된 것이다. ebp를 malloc의 땅바닥이라 생각하고 스택을 쌓아올리면 된다.

malloc의 함수 종료 부분도 살펴보자 

![Image 13](https://blog.kakaocdn.net/dna/uOci8/btsF1IeiIj2/AAAAAAAAAAAAAAAAAAAAACG3JqqBZxSi_QcBvZnqrZ7objCYKa0Jq_aDM3m80hzH/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=aBAhmkwR6rmctQR3WsWcANgoBiE%3D)

pop esi

pop ebp 

ret

![Image 14](https://blog.kakaocdn.net/dna/bcI6j3/btsF1JxweBf/AAAAAAAAAAAAAAAAAAAAABiQuiTxsYjNXytje5NEIb3phkEB0ccUisOQp6LpQKeY/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=%2BZ25z9dm5FAX7jythD7wc2qiTNY%3D)

pop ebp를 하면 해당 스택이 줄어들고 

![Image 15](https://blog.kakaocdn.net/dna/bnfure/btsF1jMRxwU/AAAAAAAAAAAAAAAAAAAAAGJFpOc46NrX5hsFXAAt07ejWtB3Ob0deM3rDYSuZwxz/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=bj2O9xxfc%2BrinKSyT0PYMhjzpcw%3D)

값이 ebp에 넣어진다. esp는 스택이 줄어들어서 0061FEDC임을 알 수 있다.

![Image 16](https://blog.kakaocdn.net/dna/Exmtr/btsF4UxwdIX/AAAAAAAAAAAAAAAAAAAAALixJENX9qMw1TamYi22Q17JTILkr9oDI3qa_mUngowV/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=HzTIXOjDXhgVGTuS09OAbeIRv78%3D)

0061FEDC를 보면 return address임을 알 수 있다.

![Image 17](https://blog.kakaocdn.net/dna/v2vSo/btsF3VXJrni/AAAAAAAAAAAAAAAAAAAAAConWF50xLgtbrBKVZWQm1z3WWhs5egFOXCQX9XbU752/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=hvTaC5zE5ZPIkoGLbZzOLooeYe8%3D)

ret를 실행하면 

![Image 18](https://blog.kakaocdn.net/dna/bHDNDU/btsF1TUn2Mu/AAAAAAAAAAAAAAAAAAAAALoN5E1s9XUxS1mv-kPGXhbjeDv7huqyx1E2IAAkc8QV/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=X1RtqS8rPaWk29sFnwgulYH00j4%3D)

위에 0061FEDC에 저장되었던 값 004012E7로 이동했음을 알 수 있다.

![Image 19](https://blog.kakaocdn.net/dna/beDEfK/btsF4zNI9fO/AAAAAAAAAAAAAAAAAAAAAAHJ0ZYxVe3tdgTpOahfrtSoBXYshW6lsGghgAuuxDtB/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1769871599&allow_ip=&allow_referer=&signature=OYs3oR37sap7EkYgsXszHt8Ci%2Bs%3D)

EBP와 ESP를 보면 malloc으로 들어가기 전 EBP, ESP 상태와 같다.