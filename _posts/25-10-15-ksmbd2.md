---
layout: post
title: "ksmbd - 2. ZDI-23-980"
categories:
  - Pwnable
tags:
  - pwn
  - kernel
last_modified_at: 2025-10-15
---

# ZDI-23-980 

이전 글에 이어서 이번엔 ZDI-23-980 내용이다. 해당 취약점은 Linux 커널의 ksmbd sub system에서 발생하는 (un)authenticated(후술하겠지만 인증 필요할 수도 있고 안 할 수도 있다) OOB read 취약점이다(network-based)

사용자는 커널 메모리에서 최대 65536바이트의 읽기를 수행할 수 있다. 해당 문제는 SSL의 Heartbleed 취약점과 유사한 buffer overead로 발생한다. 

요청 패킷에 데이터 길이 정보에 대한 검사가 없어서 그대로 처리하게 된다. 요약 하자면.. 

1. 100바이트짜리 데이터 보낼게요 
: ㅇㅇ 100바이트 읽을 준비할게요 

2. 실제로는 10바이트만 보내면 
: 서버는 100바이트 읽기로 했으니 나머지 90바이트는 memory-leak으로 읽음 

## 악용 방법 1 : SMB_WRITE 

1. dump.bin에 크기 N의 SMB_WRITE 요청
2. 실제 요청 패킷에 담긴 내용은 N보다 작도록 작성 
3. SMB_READ 요청을 보내면 dump.bin 파일이 다운됨
4. 익스 흔적을 제거하기 위해 해당 파일을 삭제

## 악용 방법 2 : SMB_ECHO 

인증은 필요없음(1번은 필요하다는 거겠지..)
대신 이 요청은 2바이트만 유출 가능하다. SMB_ECHO 보낼 때 마지막 2바이트 비워서 보내면 서버가 memory-leak으로 채운다. 

이

# the underlying issue 

smb request 패킷 헤더에 있는 smb2_hdr.NextCommand 필드에 대한 검사가 부적절하기 떄문에 해당 취약점이 발생했다. NextCommand는 현재 명령 이후에 다음 명령이 시작되는 위치(오프셋)를 나타냅니다. 

# exploit 